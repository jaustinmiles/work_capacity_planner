generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ContextEntry {
  id           String     @id
  jobContextId String
  key          String
  value        String
  category     String
  notes        String?
  createdAt    DateTime   @default(now())
  JobContext   JobContext @relation(fields: [jobContextId], references: [id], onDelete: Cascade)

  @@unique([jobContextId, key])
}

model DailySchedule {
  id        String    @id
  dayOfWeek String    @unique
  startTime String
  endTime   String
  Meeting   Meeting[]
}

model JargonEntry {
  id           String   @id
  term         String
  definition   String
  category     String?
  examples     String?
  relatedTerms String?
  sessionId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  Session      Session  @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, term])
}

model JobContext {
  id            String         @id
  name          String
  description   String
  context       String
  asyncPatterns String
  reviewCycles  String
  tools         String
  isActive      Boolean        @default(false)
  sessionId     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now())
  ContextEntry  ContextEntry[]
  Session       Session        @relation(fields: [sessionId], references: [id])
}

model Meeting {
  id            String        @id
  name          String
  startTime     String
  endTime       String
  recurring     Boolean       @default(false)
  scheduleId    String
  DailySchedule DailySchedule @relation(fields: [scheduleId], references: [id])
}

model Project {
  id        String   @id
  name      String
  color     String
  createdAt DateTime @default(now())
  Task      Task[]
}

model ScheduledTask {
  id               String   @id
  taskId           String
  scheduledDate    DateTime
  scheduledMinutes Int
  isPartial        Boolean
  isStart          Boolean
  isEnd            Boolean
  Task             Task     @relation(fields: [taskId], references: [id])
}

model SequencedTask {
  id                   String     @id
  name                 String
  importance           Int
  urgency              Int
  type                 String
  notes                String?
  dependencies         String     @default("[]")
  completed            Boolean    @default(false)
  totalDuration        Int
  criticalPathDuration Int
  worstCaseDuration    Int
  overallStatus        String     @default("not_started")
  createdAt            DateTime   @default(now())
  updatedAt            DateTime
  sessionId            String?
  deadline             DateTime?
  deadlineType         String?    // 'hard' | 'soft'
  Session              Session?   @relation(fields: [sessionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TaskStep             TaskStep[]
}

model Session {
  id                   String                 @id
  name                 String
  description          String?
  isActive             Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @default(now())
  JargonEntry          JargonEntry[]
  JobContext           JobContext[]
  SequencedTask        SequencedTask[]
  Task                 Task[]
  TimeEstimateAccuracy TimeEstimateAccuracy[]
  WorkPattern          WorkPattern[]
  ProductivityPattern  ProductivityPattern[]
  SchedulingPreferences SchedulingPreferences?
  UserTaskType         UserTaskType[]
  TimeSink             TimeSink[]
}

// User-configurable task type definition
// Session-scoped - each session has its own set of types
model UserTaskType {
  id        String   @id
  sessionId String
  name      String   // Display name (e.g., "Deep Work", "Errands")
  emoji     String   // Emoji icon (e.g., "ðŸŽ¯", "ðŸ›’")
  color     String   // Hex color (e.g., "#4A90D9")
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  Session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Time Sink - Activities that can have time logged but never complete
// Used for tracking non-task time like "phone calls with friends"
// Session-scoped - each session has its own set of time sinks
model TimeSink {
  id              String            @id
  sessionId       String
  name            String            // Display name (e.g., "Phone calls", "Social media")
  emoji           String            // Emoji icon (e.g., "ðŸ“ž", "ðŸ“±")
  color           String            // Hex color (e.g., "#9B59B6")
  typeId          String?           // Optional link to UserTaskType for categorization
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now())
  Session         Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  TimeSinkSession TimeSinkSession[]

  @@index([sessionId])
}

// TimeSinkSession - Individual time entries for a time sink
model TimeSinkSession {
  id            String    @id
  timeSinkId    String
  startTime     DateTime
  endTime       DateTime?
  actualMinutes Int?
  notes         String?
  createdAt     DateTime  @default(now())
  TimeSink      TimeSink  @relation(fields: [timeSinkId], references: [id], onDelete: Cascade)

  @@index([timeSinkId])
  @@index([startTime])
}

// Task model - Unified model for both simple tasks and workflow containers
// This replaced the old separate Task/SequencedTask models
// Tasks with hasSteps=true are workflow containers, hasSteps=false are simple tasks
model Task {
  id                   String          @id
  name                 String
  duration             Int             // Total duration in minutes (for workflows: sum of steps)
  importance           Int             // 1-10 priority scale
  urgency              Int             // 1-10 urgency scale
  type                 String          // "focused" | "admin"
  category             String          @default("work") // "work" or "personal"
  asyncWaitTime        Int             @default(0)
  dependencies         String          @default("[]")
  completed            Boolean         @default(false)
  completedAt          DateTime?
  actualDuration       Int?
  notes                String?
  projectId            String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime
  sessionId            String?
  deadline             DateTime?
  deadlineType         String?         // 'hard' | 'soft'
  cognitiveComplexity  Int?            // 1-5 scale
  isLocked             Boolean         @default(false)
  lockedStartTime      DateTime?
  hasSteps             Boolean         @default(false)
  currentStepId        String?
  overallStatus        String          @default("not_started")
  criticalPathDuration Int             @default(0)
  worstCaseDuration    Int             @default(0)
  archived             Boolean         @default(false)
  ScheduledTask        ScheduledTask[]
  Project              Project?        @relation(fields: [projectId], references: [id])
  Session              Session?        @relation(fields: [sessionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  WorkSession          WorkSession[]
  TaskStep             TaskStep[]      @relation("TaskSteps")
}

model TaskStep {
  id                   String        @id
  name                 String
  duration             Int
  type                 String
  dependsOn            String        @default("[]")
  asyncWaitTime        Int           @default(0)
  status               String        @default("pending")
  sequencedTaskId      String?       // Keep for now, but make optional
  stepIndex            Int
  taskId               String
  percentComplete      Int           @default(0)
  actualDuration       Int?
  startedAt            DateTime?
  completedAt          DateTime?
  notes                String?
  cognitiveComplexity  Int?          // 1-5 scale
  isAsyncTrigger       Boolean       @default(false)
  expectedResponseTime Int?          // in minutes
  importance           Int?          // 1-10, optional override for individual step priority
  urgency              Int?          // 1-10, optional override for individual step priority
  Task                 Task          @relation("TaskSteps", fields: [taskId], references: [id], onDelete: Cascade)
  SequencedTask        SequencedTask? @relation(fields: [sequencedTaskId], references: [id], onDelete: Cascade)
}

model TimeEstimateAccuracy {
  id               String   @id
  sessionId        String
  taskType         String
  workflowCategory String?
  estimatedMinutes Int
  actualMinutes    Int
  variance         Float
  createdAt        DateTime @default(now())
  Session          Session  @relation(fields: [sessionId], references: [id])

  @@index([taskType])
  @@index([sessionId])
}

model WorkBlock {
  id            String        @id
  patternId     String
  startTime     String
  endTime       String
  typeConfig    String        @default("{\"kind\":\"system\",\"systemType\":\"blocked\"}") // JSON: BlockTypeConfig
  totalCapacity Int           @default(0) // Total minutes available in this block
  WorkPattern   WorkPattern   @relation(fields: [patternId], references: [id], onDelete: Cascade)
  WorkSession   WorkSession[] // Sessions that occurred during this block

  @@index([patternId])
}

model WorkMeeting {
  id          String      @id
  patternId   String
  name        String
  startTime   String
  endTime     String
  type        String
  recurring   String      @default("none")
  daysOfWeek  String?
  WorkPattern WorkPattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@index([patternId])
}

model WorkPattern {
  id           String        @id
  date         String
  isTemplate   Boolean       @default(false)
  templateName String?
  sessionId    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now())
  WorkBlock    WorkBlock[]
  WorkMeeting  WorkMeeting[]
  Session      Session       @relation(fields: [sessionId], references: [id])
  WorkSession  WorkSession[]

  @@unique([sessionId, date])
}

// WorkSession model - Time tracking for tasks and workflow steps
// NOTE: There are 11+ different WorkSession interfaces throughout the codebase
// that were supposed to be unified to use this database model. See:
// - docs/INCOMPLETE_WORK.md for full consolidation status
// - src/shared/unified-work-session-types.ts for the attempted unification
model WorkSession {
  id             String       @id
  taskId         String       // Parent task (required)
  stepId         String?      // Workflow step ID (optional, for step-specific sessions)
  patternId      String?      // Work pattern reference (for scheduled sessions)
  blockId        String?      // Work block this session belongs to
  type           String?      // @deprecated - Type is derived from task/step, field will be removed
  startTime      DateTime     // Session start time
  endTime        DateTime?    // Session end time (null = in progress)
  plannedMinutes Int          @default(0)  // Estimated duration
  actualMinutes  Int?         // Actual duration (null = in progress)
  notes          String?      // Session notes/comments
  createdAt      DateTime     @default(now())
  WorkPattern    WorkPattern? @relation(fields: [patternId], references: [id])
  WorkBlock      WorkBlock?   @relation(fields: [blockId], references: [id], onDelete: SetNull)
  Task           Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([startTime])
  @@index([taskId])
  @@index([blockId])
}

model ProductivityPattern {
  id                  String   @id
  sessionId           String
  timeRangeStart      String   // "09:00"
  timeRangeEnd        String   // "12:00"
  cognitiveCapacity   String   // 'peak' | 'high' | 'moderate' | 'low'
  preferredComplexity String   @default("[]") // JSON array of preferred complexity levels
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())
  Session             Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model SchedulingPreferences {
  id                        String   @id
  sessionId                 String   @unique
  allowWeekendWork          Boolean  @default(false)
  weekendPenalty            Float    @default(0.5)
  contextSwitchPenalty      Int      @default(15)
  asyncParallelizationBonus Int      @default(20)
  bedtimeHour              Int      @default(22) // Default 10 PM (22:00)
  wakeTimeHour             Int      @default(6)  // Default 6 AM (06:00)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @default(now())
  Session                   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model ErrorLog {
  id        String   @id @default(uuid())
  level     String   // 'ERROR' | 'WARN' | 'INFO'
  message   String
  context   String   // JSON string
  error     String?  // Stack trace or error details
  sessionId String?
  userId    String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([sessionId])
  @@index([createdAt])
}

model LogMetric {
  id          String   @id @default(uuid())
  processType String   // 'main' | 'renderer'
  memoryUsage String   // JSON string
  cpuUsage    Float
  logCount    Int
  errorCount  Int
  createdAt   DateTime @default(now())

  @@index([processType])
  @@index([createdAt])
}

model AppLog {
  id        String   @id @default(cuid())
  level     String   // ERROR, WARN, INFO, DEBUG
  message   String
  source    String   // main, renderer, worker
  context   String   // JSON string of context data
  sessionId String?
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@index([level])
  @@index([source])
}
